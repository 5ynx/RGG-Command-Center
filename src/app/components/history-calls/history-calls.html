<div class="flex flex-col h-full">
    <div class="flex justify-between items-center mb-4 border-b pb-2 flex-shrink-0">
        <h2 class="text-xl font-semibold text-gray-800">Call Records & History</h2>
        <a [href]="historyUrl" class="text-sm font-medium text-emerald-400 hover:text-emerald-800">All</a>
    </div>

    <!-- Filters/Form Group -->
    <div class="mb-4 space-y-2 text-sm flex-shrink-0">
        <p class="text-xs text-gray-500 italic">Automatically deleted within 60 days</p>
        <div class="flex items-center space-x-2">
            <label class="text-gray-700 min-w-1/4">Date Filter</label>
            <!-- <input type="date" #startDate class="border border-gray-300 rounded p-1 w-full text-xs"> -->

            <div class="flex flex-row items-center border border-gray-300 rounded p-1 w-full text-xs" 
            (click)="onDisplayInputClick('historyStartDatePicker', 'historyStartDate')">
                <input
                    #startDate
                    id="historyStartDate"
                    class="w-full bg-white outline-none"
                    type="text"
                    placeholder="dd/mm/yyyy"
                    [(ngModel)]="startDateValue"
                    name="historyStartDate"
                    readonly
                />
                <svg class="hidden xl:flex" fill="#000000" width="20px" height="20px" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3,22H21a1,1,0,0,0,1-1V6a1,1,0,0,0-1-1H17V3a1,1,0,0,0-2,0V5H9V3A1,1,0,0,0,7,3V5H3A1,1,0,0,0,2,6V21A1,1,0,0,0,3,22ZM4,7H20v3H4Zm0,5H20v8H4Z"/></svg>
            </div>
            <input
                id="historyStartDatePicker"
                type="date"
                [(ngModel)]="startHiddenDateValue"
                (change)="onDateInputChange(true)"
                style="position: absolute; left: -9999px; width: 1px; height: 1px"
            />
            

            <span class="text-gray-500 text-xs">to</span>
            <div class="flex flex-row items-center border border-gray-300 rounded p-1 w-full text-xs"
            (click)="onDisplayInputClick('historyEndDatePicker', 'historyEndDate')">
                <input
                    #endDate
                    id="historyEndDate"
                    class="w-full bg-white outline-none"
                    type="text"
                    placeholder="dd/mm/yyyy"
                    [(ngModel)]="endDateValue"
                    name="historyEndDate"
                    readonly
                />
                <svg class="hidden xl:flex" fill="#000000" width="20px" height="20px" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3,22H21a1,1,0,0,0,1-1V6a1,1,0,0,0-1-1H17V3a1,1,0,0,0-2,0V5H9V3A1,1,0,0,0,7,3V5H3A1,1,0,0,0,2,6V21A1,1,0,0,0,3,22ZM4,7H20v3H4Zm0,5H20v8H4Z"/></svg>
            </div>
            <input
                id="historyEndDatePicker"
                type="date"
                [(ngModel)]="endHiddenDateValue"
                (change)="onDateInputChange(false)"
                style="position: absolute; left: -9999px; width: 1px; height: 1px"
            />
            <!-- <input type="date" #endDate class="border border-gray-300 rounded p-1 w-full text-xs"> -->
        </div>
        <div class="flex items-center space-x-2">
            <label class="text-gray-700 min-w-1/4">Attended by Filter</label>
            <select #attendantFilter class="border border-gray-300 rounded p-1 w-full text-xs">
                <option value="">Select attendant</option>
                @for (i of attendeeSelection; track i.id) {
                    <option value="{{ i.id }}" selected>{{ i.name }}</option>
                }
            </select>
            <button 
            (click)="applyFilters(attendantFilter.value)"
            class="px-3 py-1 text-sm font-medium text-white bg-emerald-400 rounded hover:bg-emerald-700 transition">Apply</button>
            <button 
            (click)="resetFilters(attendantFilter)"
            class="px-3 py-1 text-sm font-medium text-gray-700 border border-gray-300 rounded hover:bg-gray-100 transition">Reset</button>
        </div>
    </div>

    <!-- Content Area with Proper Overflow Handling -->
    <div class="flex-1 min-h-0">
        <!-- Loading Skeleton -->
        @if (loading) {
            <div class="space-y-3 pt-2 h-full overflow-y-auto">
                <div class="flex justify-between items-center text-sm border-t pt-2 pr-3">
                    <div class="flex-1">
                        <div class="h-4 bg-gray-300 rounded mb-2 w-3/4 animate-pulse"></div>
                        <div class="h-3 bg-gray-200 rounded w-1/2 animate-pulse"></div>
                    </div>
                    <div class="h-4 bg-gray-300 rounded w-20 animate-pulse"></div>
                </div>
                
                <div class="flex justify-between items-center text-sm border-t pt-2 pr-3">
                    <div class="flex-1">
                        <div class="h-4 bg-gray-300 rounded mb-2 w-2/3 animate-pulse"></div>
                        <div class="h-3 bg-gray-200 rounded w-1/3 animate-pulse"></div>
                    </div>
                    <div class="h-4 bg-gray-300 rounded w-20 animate-pulse"></div>
                </div>
                
                <div class="flex justify-between items-center text-sm border-t pt-2 pr-3">
                    <div class="flex-1">
                        <div class="h-4 bg-gray-300 rounded mb-2 w-4/5 animate-pulse"></div>
                        <div class="h-3 bg-gray-200 rounded w-2/5 animate-pulse"></div>
                    </div>
                    <div class="h-4 bg-gray-300 rounded w-20 animate-pulse"></div>
                </div>
            </div>
        }

        @if (error && !loading) {
            <div class="text-center py-8 border-t h-full flex items-center justify-center">
                <div>
                    <div class="text-red-500 mb-3">
                        <svg class="w-12 h-12 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                        </svg>
                    </div>
                    <p class="text-gray-600 mb-4">{{ error }}</p>
                    <button (click)="refreshData()" class="px-4 py-2 text-sm font-medium text-white bg-emerald-400 rounded hover:bg-emerald-700 transition">
                        Try Again
                    </button>
                </div>
            </div>
        }

        <!-- Empty State -->
        @if (!loading && !error && callHistory.length === 0) {
            <div class="text-center py-8 border-t h-full flex items-center justify-center">
                <div>
                    <div class="text-gray-400 mb-3">
                        <svg class="w-12 h-12 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                    </div>
                    <p class="text-gray-600">No call records found.</p>
                </div>
            </div>
        }

        <!-- Actual Data -->
        @if (!loading && !error && callHistory.length > 0) {
            <div class="h-full overflow-y-auto">
                <div class="space-y-3 pt-2 pb-2">
                    @for (record of callHistory.slice().reverse(); track record.id) {
                        <div class="flex justify-between items-center text-sm border-t pt-2 pr-3">
                            <div>
                                <p class="font-medium text-gray-900">{{ record.name || 'Unnamed Record' }}</p>
                                <p class="text-gray-500">{{ record.create_date }}</p>
                            </div>
                            <button 
                                (click)="printRecord(record)" 
                                [disabled]="isDownloading(record.id)"
                                class="text-emerald-400 hover:underline disabled:text-gray-400 disabled:cursor-not-allowed">
                                {{ isDownloading(record.id) ? 'Downloading...' : 'Download' }}
                            </button>
                        </div>
                    }
                </div>
            </div>
        }
    </div>
</div>